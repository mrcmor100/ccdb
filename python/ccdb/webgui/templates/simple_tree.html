{% extends 'dash_base.html' %}

{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<style>
.tree, .tree ul {
    margin:0;
    padding:0;
    list-style:none;
    font-size: 1.1em;
}
.tree ul {
    margin-left:1em;
    position:relative;
}
.tree ul ul {
    margin-left:.5em;
}
.tree ul ul:before {
    content:"";
    display:block;
    width:0;
    position:absolute;
    top:0;
    bottom:0;
    left:0;
    border-left:1px solid;
}
.tree li {
    margin:0;
    padding:0 1em;
    line-height:2em;
    color: #000000;
    font-weight:700;
    position:relative;
}
.tree ul ul li:before {
    content:"";
    display:block;
    width:10px;
    height:0;
    border-top:1px solid;
    margin-top:-1px;
    position:absolute;
    top:1em;
    left:0;
}
.tree ul li:last-child:before {
    background:#fff;
    height:auto;
    top:1em;
    bottom:0;
}
.indicator {
    margin-right:8px;
}
.tree li a {
    text-decoration: none;
    color: #000000;
}
.tree li button, .tree li button:active, .tree li button:focus {
    text-decoration: none;
    color: #2738b3;
    border:none;
    background:transparent;
    margin:0px 0px 0px 0px;
    padding:0px 0px 0px 0px;
    outline: 0;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 15%;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.btn-icon {
    background: none;
    border: none;
    color: inherit;
    padding: 0;
    cursor: pointer;
}

</style>


<h1 class="text-center my-4">{% block title %}Tables{% endblock %}</h1>
{% endblock %}
{% block content %}
<div class="container mt-3">
  <div id="tree2" class="tree">
    {{ html_tree | safe }}
  </div>
</div>

<div class="modal" id="infoModal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body"></div>
      </div>
</div>


<script type="text/javascript">

$(document).on('click', '.btn-icon', function() {
    var button = $(this);
    if (button.closest('li').has('a').length > 0) {
        var tableId = button.closest('li').find('a').attr('href').split('/')[2]; // Предположим, что URL структурирован таким образом
        showTableInfo(tableId);
    } else {
        var dirId = button.data('dir-id');
        showDirInfo(dirId);
    }
});

function showDirInfo(dirId) {
  fetch(`/get-dir-info/${dirId}`)
    .then(response => response.text())
    .then(html => {
      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('infoModal').style.display = 'block';
    });
}

function showTableInfo(tableId) {
  fetch(`/get-table-info/${tableId}`)
    .then(response => response.text())
    .then(html => {
      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('infoModal').style.display = 'block';
    });
}

function closeModal() {
  document.getElementById('infoModal').style.display = 'none';
}

$(document).ready(function() {
    $.fn.extend({
        treed: function (o) {
          var openedClass = 'bi-folder2-open';
          var closedClass = 'bi-folder';
          var fileClass = 'bi-table';

          if (typeof o != 'undefined'){
            if (typeof o.openedClass != 'undefined'){
                openedClass = o.openedClass;
            }
            if (typeof o.closedClass != 'undefined'){
                closedClass = o.closedClass;
            }
          }

            var tree = $(this);
            tree.addClass("tree");
            tree.find('li').has("ul").each(function () {
                var branch = $(this);
                branch.prepend("<i class='indicator bi " + closedClass + "'></i>");
                branch.addClass('branch');

                branch.on('click', function (e) {
                    if (!$(e.target).is('a')) {
                        var icon = $(this).children('i:first');
                        icon.toggleClass(openedClass + " " + closedClass);
                        $(this).children().children().toggle();
                        e.stopPropagation();
                    }
                });
                branch.children().children().toggle();
            });

            tree.find('li:not(:has(ul))').prepend("<i class='indicator bi " + fileClass + "'></i>");

            tree.find('.indicator').on('click', function (e) {
                $(this).closest('li').click();
                e.stopPropagation();
            });

            tree.find('a').on('click', function (e) {
                e.stopPropagation();
            });
        }
    });

    $('#tree2').treed();
});

</script>
{% endblock %}
